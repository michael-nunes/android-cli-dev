#!/bin/bash
APPNAME=$(gum input --placeholder "MyApp" --header "App Name")

APPNAME_SANE=$(echo "$APPNAME" | tr ' ' " | tr '-' ")


PKG_ID=$(gum input --placeholder "com.myapp.myapp" --header "Package Id")
if [[ ! "$PKG_ID" =~ ^[a-z][a-z0-9_]*(\.[a-z0-9_]+)+$ ]]; then
	gum style --foreground 1 "Invalid ID"
	exit 1
fi

gum style --foreground 2 "Project Sumary"
gum style --bold "Name:" "$APPNAME"
gum style --bold "Package ID:" "$PKG_ID"
gum confirm "Create Project?" || exit 0
PROJECT_DIR=~/projects/"$APPNAME_SANE"
gum style --foreground 2 "Project Location" "$PROJECT_DIR"

mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR"
gum spin --spinner dot --title "Creating Project Structure ..." sleep 1

# BUILD.GRADLE
cat > build.gradle <<EOF
buildscript {
	repositories { google(); mavenCentral() }
	dependencies { classpath 'com.android.tools.build:gradle:8.2.0' }
}
allprojects { repositories { google(); mavenCentral() } }
EOF


# APP/BUILD.GRADLE
mkdir -p app/src/main
cat > app/build.gradle <<EOF
apply plugin: 'com.android.application'

android {
	namespace:'$PKG_ID'
	compileSdk 34
	defaultConfig {
		applicationId "$PKG_ID"
		minSdk 21
		targetSdk 34
		versionCode 1
		versionName "1.0"
	}
	buildTypes.release { minifyEnabled false }

}
dependencies {
	implementation 'androidx.appcompat:appcompat:1.6.1'
	implementation 'androidx.core:core-ktx:1.12.0'
}
EOF


# MANIFEST
cat > app/src/main/AndroidManifest.xml << EOF
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
	<uses-permission android:name="android.permission.POST_NOTIFICATION" />
	<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
	<uses-permission android:name="android.permission.WAKE_LOCK" />
	<application android:label="$APPNAME" android:theme="@android:style/Theme.DeviceDefault.DayNight" >
		<activity android:name=".MainActivity" android:exported="true">
			<intent-filter>
				<action android:name="android.intent.action.MAIN_ACTIVITY />
				<category android:name="android.intent.category.LAUNCHER />
			</intent-filter>
		</activity>
		<receiver android:name=".ReminderReceiver" android:exported="false" />
	</application>
</manifest>
EOF

# Kotlin: MainActivity
mkdir -p app/src/main/java/$(echo $PKG_ID | tr '.' '/')
cat > app/src/main/java/$(echo $PKG_ID | tr '.' '/')/MainActivity.kt <<EOF
package $PKG_ID

import android.app.AlarmManager
import android.app.PendingIntent
import android.content.Context
import android.content.Intent
import android.os.Bundle
import android.webkit.*
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {
	private lateinit var webView:WebView
	override fun onCreate(savedInstaceState: Bundle?) {
		super.onCreate(savedInstaceState)
		webView = WebView(this)
		setContent(webView)
		with(webView.settings) {
			javascriptEnabled = true
			domStorageEnabled = true
			allowFileAccess = true
		}
		webView.addJavascriptInterface(JsInterface(),"Android")
		webView.loadUrl("file:///android_assets/index.html")
	}
	inner class JsInterface {
		@JavascriptInterface
		fun scheduleReminder(dalayMs: Long, title:String, message:String, bigText:String?) {
			val intent = Intent(this@MainActivity,ReminderReceiver::class.java).apply {
				putExtra("title", title)
				putExtra("message", message)
				putExtra("bigText", bigText)
			}
			
		}
	}
}

EOF

