#!/bin/bash
set -e

report_error() { 
	echo "$1"; 
	exit "$2" 
}
report_info() { 
	echo "$@" 
}

confirm_ask() {
	local _r
	read _r
	echo "$_r"
}

check_remote_file() {
	curl --head -s "$1"
}

# Check if has project file description
[ ! -f "./project" ] && report_error "project file not found" 1

source "./project"
PROJECT_VANJS_VERSION=${PROJECT_VANJS_VERSION:-"1.6.0"}
PROJECT_NAME_SANE=$(echo "$PROJECT_NAME" | tr ' ' " | tr '-' ")
if [[ ! "$PROJECT_PACKAGE" =~ ^[a-z][a-z0-9_]*(\.[a-z0-9_]+)+$ ]]; then
	report_error "Invalid PROJECT_PACKAGE" 1
fi

VANJS_URL="https://cdn.jsdelivr.net/gh/vanjs-org/van/public/van-$PROJECT_VANJS_VERSION.nomodule.min.js"
report_info "Checking VanJS..."
if [[ ! $(check_remote_file "$VANJS_URL") ]]; then
	report_error "Cannot found vanjs $VANJS_VERSION, tryed $VANJS_URL" 1
fi

PROJECT_DIR="$(pwd)/$PROJECT_NAME_SANE"
report_info "Project Name:" "$PROJECT_NAME"
report_info "Project Package:" "$PROJECT_PACKAGE"
report_info "VanJS Version:" "$PROJECT_VANJS_VERSION"
report_info "Project Dir:" "$PROJECT_DIR"

report_info "Confirm project creation?[y/n]"
if [[ ! "$(confirm_ask)" =~ ^[syYy][\s]*$ ]]; then
	report_info "Project creation cancelled"
	exit 0;
fi

PROJECT_PACKAGE_FOLDER=$(echo $PROJECT_PACKAGE | tr '.' '/')


report_info "Creating project structure..."
mkdir -p "$PROJECT_DIR"
cd "$PROJECT_DIR"



# Tools
mkdir tools
cat > tools/get-deps.sh << 'EOF'
cd "$PROJECT_HOME"
wget -q -O libs/appcompat.aar "https://maven.google.com/androidx/appcompat/appcompat/1.6.1/appcompat-1.6.1.aar"
# androidx.core:core:1.12.0
wget -q -O libs/core.aar "https://maven.google.com/androidx/core/core/1.12.0/core-1.12.0.aar"
# androidx.webkit:webkit:1.7.0
wget -q -O libs/webkit.aar "https://maven.google.com/androidx/webkit/webkit/1.7.0/webkit-1.7.0.aar"

# Extract classes.jar from each AAR
for aar in libs/*.aar; do
  unzip -o "$aar" classes.jar -d libs/
  mv libs/classes.jar "libs/$(basename "$aar" .aar)-classes.jar"
done
echo "AndroidX ready in ./libs/"
EOF

cat > build.sh << 'EOF'
#!/bin/bash
set -e
ANDROID_HOME=${ANDROID_HOME:-$HOME/Sdks/android}
JAVA_HOME="/usr/lib/jvm/java-17-openjdk"
PLATFORM=android-34
BUILD_TOOLS=34.0.0
JC=$JAVA_HOME/bin/javac
BT=$ANDROID_HOME/build-tools/$BUILD_TOOLS
ANDROID_JAR="$ANDROID_HOME/platforms/$PLATFORM/android.jar"
EOF
cat >> build.sh << EOF
PROJECT_HOME="$PROJECT_DIR"
APP_NAME="$PROJECT_NAME"
PACKAGE_FOLDER="$PROJECT_PACKAGE_FOLDER"
mkdir -p bin/dex
mkdir -p res/drawable
mkdir -p libs
[ ! -f libs/appcompat-classes.jar ] && env PROJECT_HOME="\$PROJECT_HOME" ./tools/get-deps.sh
EOF
cat >> build.sh << 'EOF'

# STEP 1, GENERATE R.java
$BT/aapt package -f -m -M AndroidManifest.xml -J src/main/java -S res -I "$ANDROID_JAR"

# STEP 2, COMPILE JAVA CODE
$JC -cp "$ANDROID_JAR:libs/*:src/main/java" -d bin/classes src/main/java/$PACKAGE_FOLDER/*.java

# STEP 3, GENERATE DEX
$BT/d8 bin/classes/$PACKAGE_FOLDER/*.class --output bin/dex --min-api 24


# STEP 4, GENERATE APK
APK_UNALIGNED="$PROJECT_HOME/bin/app.unaligned.apk"
$BT/aapt package -f -M AndroidManifest.xml -S res -I "$ANDROID_JAR" -F "$APK_UNALIGNED" --target-sdk-version 24

cd bin/dex
$BT/aapt add "$APK_UNALIGNED" classes.dex
cd "$PROJECT_HOME" 
$BT/aapt add "$APK_UNALIGNED" assets/*

# STEP 5, ALIGN APK
$BT/zipalign -f 4 "$APK_UNALIGNED" "$APP_NAME".apk
APK_KEYSTORE="$HOME/.android/appkey.jks"
if [ ! -f "$APK_KEYSTORE" ]; then
	$JAVA_HOME/bin/keytool -genkey -v -keystore "$APK_KEYSTORE" -alias appkey -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Dev" -storepass android -keypass android -noprompt
fi

$BT/apksigner sign --ks "$APK_KEYSTORE" --ks-pass pass:android "$APP_NAME".apk

EOF

chmod +x tools/get-deps.sh
chmod +x build.sh

# Assets
report_info "Downloading VanJS..."
mkdir assets
cd assets
curl -LO "$VANJS_URL"

# Template index.html
cat > index.html <<EOF
<!DOCTYPE html>
<html lang=pt-BR">
	<head>
		<title> $PROJECT_NAME_SANE </title>
		<meta name="viewport" content="width=device-width,initial-scale=1">
		<meta charset="utf-8" />
	</head>
	<body>
		<div id="App"></div>
		<script src="van-$PROJECT_VANJS_VERSION.nomodule.min.js"></script>
		<script src="app.js"></script>
		<script type="text/javascript">
			document.addEventListener("DOMContentLoaded", ()=> van.add(document.getElementById("App"), App));
		</script>
	</body>
</html>
EOF

# Template app.js
cat > app.js <<EOF
function App() {
	const { div, h1, button } = van.tags;
	const count = van.state(1)
	return div(
		h1("My First VanJS Android App:", count),
		button({onclick: ()=> count.val += 1 }, "Click")
	);

}
EOF

cd "$PROJECT_DIR"

# GENERATE AndroidManifest
cat > AndroidManifest.xml <<EOF
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
	package="$PROJECT_PACKAGE">
	<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />
	<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />
	<uses-permission android:name="android.permission.WAKE_LOCK" />
	<application android:label="$PROJECT_NAME_SANE" >
		<activity android:name=".MainActivity" android:exported="true">
			<intent-filter>
				<action android:name="android.intent.action.MAIN" />
				<category android:name="android.intent.category.LAUNCHER" />
			</intent-filter>
		</activity>
		<receiver android:name=".ReminderReceiver" android:exported="false" />
	</application>
</manifest>
EOF


# GENERATE MainActivity
mkdir -p src/main/java/$PROJECT_PACKAGE_FOLDER
cat > src/main/java/$PROJECT_PACKAGE_FOLDER/MainActivity.java << EOF
package $PROJECT_PACKAGE;

import android.app.Activity;
import android.app.AlarmManager;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.webkit.JavascriptInterface;
import android.webkit.WebView;
import android.webkit.WebViewClient;

public class MainActivity extends Activity {
    private WebView webView;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        webView = new WebView(this);
        setContentView(webView);

        webView.getSettings().setJavaScriptEnabled(true);
        webView.getSettings().setDomStorageEnabled(true);
        webView.setWebViewClient(new WebViewClient());
        webView.addJavascriptInterface(new JsBridge(), "Android");
        webView.loadUrl("file:///android_asset/index.html");
    }

    public class JsBridge {
        @JavascriptInterface
        public void scheduleReminder(long delayMs, String title, String message) {
            Intent intent = new Intent(MainActivity.this, ReminderReceiver.class);
            intent.putExtra("title", title);
            intent.putExtra("message", message);
            PendingIntent pending = PendingIntent.getBroadcast(
                MainActivity.this, 0, intent,
                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
            );
            AlarmManager alarm = (AlarmManager) getSystemService(ALARM_SERVICE);
            alarm.setExact(AlarmManager.RTC_WAKEUP, System.currentTimeMillis() + delayMs, pending);
        }
    }

    @Override
    public void onBackPressed() {
        if (webView.canGoBack()) webView.goBack();
        else super.onBackPressed();
    }
}
EOF

cat > src/main/java/$PROJECT_PACKAGE_FOLDER/ReminderReceiver.java << EOF
package $PROJECT_PACKAGE;
import android.app.NotificationChannel;
import android.app.NotificationManager;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import androidx.core.app.NotificationCompat;

public class ReminderReceiver extends BroadcastReceiver {
    @Override
    public void onReceive(Context context, Intent intent) {
        String title = intent.getStringExtra("title");
        String message = intent.getStringExtra("message");

        NotificationManager nm = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
        String channelId = "reminders";
        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.O) {
            nm.createNotificationChannel(new NotificationChannel(channelId, "Reminders", NotificationManager.IMPORTANCE_HIGH));
        }

        Intent activityIntent = new Intent(context, MainActivity.class);
        PendingIntent pending = PendingIntent.getActivity(context, 0, activityIntent, PendingIntent.FLAG_IMMUTABLE);

        NotificationCompat.Builder builder = new NotificationCompat.Builder(context, channelId)
            .setSmallIcon(android.R.drawable.ic_dialog_info)
            .setContentTitle(title)
            .setContentText(message)
            .setPriority(NotificationCompat.PRIORITY_HIGH)
            .setContentIntent(pending)
            .setAutoCancel(true);

        nm.notify(1, builder.build());
    }
}
EOF






